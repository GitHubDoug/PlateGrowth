---
title: "Import microbial plate growth data"
author: "Maximilian Berthold, Douglas A. Campbell"
date: "`r format(Sys.Date())`"
output:
  html_document:
    df_print: paged
    code_folding: hide
---

This .Rmd imports Molecular Device Fluorescence well plate files, generated using the emission scan/excitation scan protocol.
The size of the well plate does not matter; the import creates columns for RowColumn LetterNumber (A01 etc.) for the largest plate type in the list of files.
Import of smaller plate types results in NA in the non-existent RowColumn for that plate.

```{r load libraries, echo=FALSE, message = FALSE, warning = FALSE} 
# libraries; Note check actual dependencies
library(tidyverse)
library(purrr)
library(lubridate)
library(googledrive)
library(googlesheets4)

```

```{r variable names for file import & processing MOLECULAR DEVICES}
Project <- "BIOL2201"

#deauthorizes access to googlesheet
gs4_deauth()

#read contents of MetaData from GoogleSheet
MetaData <- read_sheet("https://docs.google.com/spreadsheets/d/1FTKwYlJXd0ze9WwVXCvtwe5qkpN3_HNbeeM3hg7xnrI/edit#gid=0")

#set variables for file import & processing
DataPathMD <- file.path("RawData", "TestPlate", fsep = .Platform$file.sep)
file_id <- ".txt"

DataOut <- "ProcessData"

FileEncodeMD <- "UTF-16LE" 
DelimiterMD <- "\t"
HeaderRowsMD <- 17

#list of files
OD_files <- list.files(path = DataPathMD, pattern = file_id, full.names = TRUE)

OD_files
#test for duplicate file names in chl_files
unique(duplicated(OD_files))
```
```{r guess encoding}
guess_encoding(file = OD_files[1])
```

```{read files}
#read MD data using map_df
read.delim_plus <- function(flnm, file_encode, delimiter, header_rows){read.delim(flnm, fileEncoding = file_encode, sep = delimiter,  skip = header_rows, row.names = NULL) %>% 
    mutate(filename = flnm)
}

#"id" parameter of read_delim might replace read_delim_plus
#a read function using tidyverse::read_delim that skips a fixed number of header rows, and adds columns to the dataframe containing the filename and the file creation date time.
read_delim_plus <- function(flnm, delimiter, headerrows, fileencode){read_delim(flnm, delim = delimiter,  col_names = TRUE,  skip = headerrows, escape_double = FALSE,  locale = locale(encoding = fileencode), trim_ws = TRUE) %>%
    mutate(Filename = flnm))
  }


OD_data <- OD_files %>% 
  map_df(~read.delim_plus(flnm = ., file_encode = FileEncodeMD, delimiter = DelimiterMD, header_rows = HeaderRowsMD))

```


```{tidy OD_data}
# tidy up MD files

#from filename
GrowthLong <- ChlExMD %>% 
  separate(col = filename, into = c("FP1", "Project", "ExWL", "EmWL", "date" ,"time", "Plate","txt"), sep = "([\\/\\_\\.\\:])", remove = FALSE) %>% 
  filter(!str_detect(Wavelength, pattern = "~End"),
         !str_detect(Wavelength, pattern = "Original Filename")) %>%
  separate(col = ExWL, into = c("Ex","ExLambda"), sep = 2) %>%
  separate(col = EmWL, into = c("Em", "EmLambda"), sep = 2) %>%
  separate(col = Plate, into = c("cplate", "Plate"), sep = 5) %>%
  select(-c(FP1, txt, cplate, X, 'Temperature..C.')) %>%
  unite(datetime, date, time, remove = FALSE) %>%
  mutate(datetime = ymd_hm(datetime),
         Wavelength = as.numeric(Wavelength),
         Plate = as.numeric(Plate)) %>%
  pivot_longer(cols = -c(Wavelength, filename:Plate), names_to = "Well", values_to = "RFU") %>%
  inner_join(MetaData) %>%
  group_by(CultureID) %>% 
  mutate(E_hours = as.numeric((datetime - datetime[1])/3600)) %>% 
  ungroup() #%>%
  # select(-c(KNO3_mL:Glucose_mL)) %>%
  # pivot_longer(cols = c(FinalKNO3_uM:FinalGlucose_uM), names_to = "AddedNutrient", values_to = "NutrientConcentration")
  
```


```{r fluor growth plot}
Wavelength_nm = 680
Plates = c(104)
Groups = 4
Nutrients = c("FinalKNO3_uM", "FinalPO4_uM", "FinalCO3_uM", "FinalFe_uM", "FinalGlucose_uM")

GrowthLong %>%
  filter(Wavelength == Wavelength_nm) %>%
  #filter(Group %in% Groups) %>%
  #filter(Plate %in% Plates) %>%
  #filter(AddedNutrient %in% Nutrients) %>%
  #drop_na(NutrientConcentration) %>%
  ggplot()+
  geom_point(aes(x = E_hours, y = (RFU))) +
  theme_bw() + 
  labs(caption = paste(Wavelength_nm, "nm", "Group", Groups))


```


```{r save GrowthLong, echo=FALSE}
saveRDS(GrowthLong, file.path(DataOut, 
paste(Project, file_id, "GrowthLong.Rds", sep = "_"), fsep = .Platform$file.sep))
```

``` {r alternative sorting}
GrowthLongAlt <- ChlExMD %>% 
  separate(col = filename, into = c("FP1", "Project", "ExWL", "EmWL", "date" ,"time", "Plate","txt"), sep = "([\\/\\_\\.\\:])", remove = FALSE) %>% 
  filter(!str_detect(Wavelength, pattern = "~End"),
         !str_detect(Wavelength, pattern = "Original Filename")) %>%
  separate(col = ExWL, into = c("Ex","ExLambda"), sep = 2) %>%
  separate(col = EmWL, into = c("Em", "EmLambda"), sep = 2) %>%
  separate(col = Plate, into = c("cplate", "Plate"), sep = 5) %>%
  select(-c(FP1, txt, cplate, X, 'Temperature..C.')) %>%
  unite(datetime, date, time, remove = FALSE) %>%
  mutate(datetime = ymd_hm(datetime),
         Wavelength = as.numeric(Wavelength),
         Plate = as.numeric(Plate)) %>%
  pivot_longer(cols = -c(Wavelength, filename:Plate), names_to = "Well", values_to = "RFU") %>%
  inner_join(MetaData) %>%
  group_by(CultureID) %>% 
  mutate(E_hours = as.numeric((datetime - datetime[1])/3600)) %>% 
  ungroup() %>%
  select(-c(KNO3_mL:Glucose_mL)) %>%
  pivot_longer(cols = c(FinalKNO3_uM:FinalGlucose_uM), names_to = "AddedNutrient", values_to = "NutrientConcentration")

Wavelength_nm = 680
Plates = c(102)
Groups = 2
Nutrients = c("FinalKNO3_uM", "FinalPO4_uM", "FinalCO3_uM", "FinalFe_uM", "FinalGlucose_uM")

GrowthLongAlt %>%
  filter(Wavelength == Wavelength_nm) %>%
  filter(Group %in% Groups) %>%
  filter(Plate %in% Plates) %>%
  filter(AddedNutrient %in% Nutrients) %>%
  filter(NutrientConcentration != 0) %>%
  ggplot()+
  geom_point(aes(x = E_hours, y = (RFU), colour = as.factor(Well))) +
  facet_grid(cols = vars(AddedNutrient),
             rows = vars(NutrientConcentration)) + 
  theme_bw() + 
  labs(caption = paste(Wavelength_nm, "nm", "Group", Groups))


```

